<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DreamApp v4.4.6 – Modular Desktop</title>
<style>
  :root{
    --bg:#0f1220; --panel:#161a2b; --ink:#e9efff; --muted:#93a0c2;
    --accent:#7cc6ff; --accent-2:#444dd8; --border:#26324a;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:14px;
    --sidebar-w: 280px;
    --sidebar-w-min: 56px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    overflow:hidden;
  }
  .app{ display:grid; grid-template-columns: var(--sidebar-w) 1fr; height:100%; }

  /* Sidebar */
  .sidebar{
    background:linear-gradient(180deg, #0f1326 0%, #0c0f1f 100%);
    border-right:1px solid var(--border);
    overflow:hidden; position:relative; transition: width .2s ease;
    width:var(--sidebar-w);
  }
  .sidebar__inner{ height:100%; overflow:auto; padding:16px; }
  .sidebar h1{ margin:0 0 10px; font-size:16px; display:flex; gap:8px; align-items:center; }
  .badge{font-size:12px; color:#cdd7ff; background:#1f2440; border:1px solid #2a335a; padding:2px 8px; border-radius:999px;}
  .toggle{
    position:absolute; top:10px; right:10px;
    background:#141836; border:1px solid var(--border); color:var(--ink);
    border-radius:10px; padding:6px 10px; cursor:pointer; z-index:2;
  }
  .collapsed .sidebar__inner{ padding:12px 8px; }
  .collapsed .section-title, .collapsed .about, .collapsed .tip, .collapsed .btn-label { display:none; }
  .collapsed .menu{ gap:8px; }
  .collapsed .menu button{ justify-content:center; }

  /* Resizable gutter */
  .splitter{
    position:absolute; top:0; right:-4px; width:8px; height:100%;
    cursor:col-resize; z-index:3;
  }

  /* Menu */
  .menu{ display:flex; flex-direction:column; gap:10px; margin:14px 0 18px; }
  .menu button{
    display:flex; align-items:center; gap:10px;
    width:100%; padding:12px; text-align:left;
    color:var(--ink); background:#12162c; border:1px solid var(--border);
    border-radius:10px; cursor:grab; user-select:none; transition:border-color .15s ease, box-shadow .15s ease;
  }
  .menu button:active{ cursor:grabbing; }
  .menu button.drag-over{ outline:2px dashed var(--accent); }
  .menu .handle{ font-weight:700; color:#6f7bb0; }
  .menu .btn-label{ flex:1; }
  .menu .dot{ width:8px; height:8px; border-radius:50%; background:var(--accent-2); opacity:.5; }
  .menu button.active{ border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent) inset; }

  /* Desktop */
  .desktop{ position:relative; height:100%; overflow:auto; padding:20px 24px 40px; }

  /* Windows */
  .win{
    position:absolute; display:flex; flex-direction:column;
    background:var(--panel); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow);
    width:520px; min-height:160px;
  }
  .win__head{
    padding:12px 14px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:10px; cursor:move;
  }
  .win__title{ font-weight:600; color:#cfe3ff; font-size:13.5px; flex:1; }
  .win__close{
    background:#1a2042; border:1px solid var(--border); color:#cfd7ff;
    border-radius:8px; padding:4px 8px; cursor:pointer; font-weight:700;
  }
  .win__body{ padding:12px; overflow:auto; flex:1; }
  .win__actions{ display:flex; gap:8px; padding:0 12px 12px; flex-wrap:wrap; }
  .btn{ background:#1a2042; border:1px solid var(--border); color:var(--ink);
        padding:8px 10px; border-radius:10px; cursor:pointer; }
  .btn.primary{ background:#1a2a4f; border-color:#2b3a6b; }
  textarea, select, input{
    width:100%; background:#0f1635; color:var(--ink); border:1px solid var(--border);
    border-radius:10px; padding:10px; resize:vertical; min-height:100px;
  }
  input{ min-height:auto; }

  /* Resizers */
  .resizer{ position:absolute; background:transparent; }
  .r-n{ top:-3px; left:10px; right:10px; height:6px; cursor:n-resize; }
  .r-s{ bottom:-3px; left:10px; right:10px; height:6px; cursor:s-resize; }
  .r-e{ top:10px; right:-3px; bottom:10px; width:6px; cursor:e-resize; }
  .r-w{ top:10px; left:-3px; bottom:10px; width:6px; cursor:w-resize; }
  .r-ne{ top:-4px; right:-4px; width:10px; height:10px; cursor:ne-resize; }
  .r-nw{ top:-4px; left:-4px; width:10px; height:10px; cursor:nw-resize; }
  .r-se{ bottom:-4px; right:-4px; width:10px; height:10px; cursor:se-resize; }
  .r-sw{ bottom:-4px; left:-4px; width:10px; height:10px; cursor:sw-resize; }

  /* Scrollbars */
  .desktop::-webkit-scrollbar,
  .win__body::-webkit-scrollbar,
  .sidebar__inner::-webkit-scrollbar{ width:10px; height:10px; }
  .desktop::-webkit-scrollbar-track,
  .win__body::-webkit-scrollbar-track,
  .sidebar__inner::-webkit-scrollbar-track{ background:transparent; }
  .desktop::-webkit-scrollbar-thumb,
  .win__body::-webkit-scrollbar-thumb,
  .sidebar__inner::-webkit-scrollbar-thumb{ background:#262c45; border-radius:8px; }
  .desktop:hover::-webkit-scrollbar-thumb,
  .win__body:hover::-webkit-scrollbar-thumb,
  .sidebar__inner:hover::-webkit-scrollbar-thumb{ background:#3a4370; }
  .desktop, .win__body, .sidebar__inner{ scrollbar-color:#262c45 transparent; }
  .desktop:hover, .win__body:hover, .sidebar__inner:hover{ scrollbar-color:#3a4370 transparent; }

  .section-title{ color:#a9b6dc; margin:14px 0 6px; }
  .note{ font-size:12.5px; color:var(--muted); }

  /* user badge */
  #userBadge {
    position: fixed; top: 8px; right: 12px; z-index: 1200;
    background: rgba(120,140,255,0.12); color: #cfd8ff;
    border: 1px solid rgba(120,140,255,0.35);
    padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600;
    pointer-events: none;
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" id="sidebar">
      <button class="toggle" id="toggle">☰</button>
      <div class="splitter" id="splitter" title="Drag to resize"></div>

      <div class="sidebar__inner">
        <h1>DreamApp <span class="badge">v4.4.6</span></h1>

        <div class="section-title">Windows</div>
        <div class="menu" id="menu" aria-label="Drag to reorder">
          <button draggable="true" data-target="win-framework"><span class="handle">⋮⋮</span><span class="btn-label">Framework & Dream</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-prompt"><span class="handle">⋮⋮</span><span class="btn-label">Prompt Preview / Copy</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-depth"><span class="handle">⋮⋮</span><span class="btn-label">Depth Prompt</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-output"><span class="handle">⋮⋮</span><span class="btn-label">Model Output (paste)</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-depthout"><span class="handle">⋮⋮</span><span class="btn-label">Depth Output</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-notes"><span class="handle">⋮⋮</span><span class="btn-label">Notes</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-wakeprompt"><span class="handle">⋮⋮</span><span class="btn-label">Waking Context Prompt</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-wakeout"><span class="handle">⋮⋮</span><span class="btn-label">Waking Context Output</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-library"><span class="handle">⋮⋮</span><span class="btn-label">Library</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-storage-log"><span class="handle">⋮⋮</span><span class="btn-label">Storage Log</span><span class="dot"></span></button>
          <button draggable="true" data-target="win-settings"><span class="handle">⋮⋮</span><span class="btn-label">Settings</span><span class="dot"></span></button>
        </div>

        <div class="tip">Tip: drag window headers to move; drag any edge/corner to resize.</div>

        <div class="about" style="margin-top:14px;">
          <div class="section-title">About</div>
          <div class="note">
            Client-only prototype. Copy prompts into your model and paste results back. Window layout is autosaved locally.
          </div>
        </div>
      </div>
    </aside>

    <main class="desktop" id="desktop">
      <!-- Framework & Dream -->
      <section class="win" id="win-framework" style="left:24px; top:24px; width:680px;">
        <header class="win__head">
          <div class="win__title">Framework & Dream</div>
          <button class="win__close" data-close="win-framework">✕</button>
        </header>
        <div class="win__body">
          <label>Interpretation framework</label>
          <select id="framework">
            <option>Jungian (v1)</option>
            <option>Freudian (v2)</option>
            <option>Gestalt (v3)</option>
            <option>Shamanic (v1)</option>
            <option>Cognitive/Neuropsych (v1)</option>
          </select>

          <!-- Dream Name (not used in prompts) -->
          <label style="display:block;margin-top:12px;">Dream Name (not used in prompts)</label>
          <input id="dreamName" type="text" placeholder="e.g., warehouse-return" style="min-height:auto;">

          <label style="display:block;margin-top:10px;">Dream text</label>
          <textarea id="dream" placeholder="Paste your dream here..."></textarea>
        </div>
        <div class="win__actions">
          <button class="btn primary" id="copyFrameworkPrompt">Copy framework prompt (Standard)</button>
          <button class="btn" id="clearDream">Clear</button>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Prompt Preview -->
      <section class="win" id="win-prompt" style="left:24px; top:370px; width:680px;">
        <header class="win__head">
          <div class="win__title">Prompt Preview / Copy</div>
          <button class="win__close" data-close="win-prompt">✕</button>
        </header>
        <div class="win__body">
          <textarea id="promptPreview" placeholder="Framework prompt preview will appear here…"></textarea>
        </div>
        <div class="win__actions">
          <button class="btn" id="copyPrompt">Copy</button>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Depth Prompt -->
      <section class="win" id="win-depth" style="left:740px; top:24px; width:560px;">
        <header class="win__head">
          <div class="win__title">Depth Prompt</div>
          <button class="win__close" data-close="win-depth">✕</button>
        </header>
        <div class="win__body">
          <textarea id="depthPrompt" placeholder="Depth prompt (Plain / Standard / Advanced) will generate here…"></textarea>
        </div>
        <div class="win__actions">
          <button class="btn" id="copyDepth">Copy Depth prompt</button>
          <button class="btn" id="clearDepth">Clear</button>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Model Output -->
      <section class="win" id="win-output" style="left:24px; top:720px; width:680px; height:280px;">
        <header class="win__head">
          <div class="win__title">Model Output (paste here)</div>
          <button class="win__close" data-close="win-output">✕</button>
        </header>
        <div class="win__body">
          <textarea id="modelOutput" placeholder="Paste the model's interpretation here…"></textarea>
        </div>
        <div class="win__actions">
          <button class="btn" id="genDepthPlain">Generate depth from Model Output: Plain</button>
          <button class="btn" id="genDepthStandard">Generate: Standard</button>
          <button class="btn" id="genDepthAdvanced">Generate: Advanced</button>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Depth Output -->
      <section class="win" id="win-depthout" style="left:740px; top:420px; width:560px; height:280px;">
        <header class="win__head">
          <div class="win__title">Depth Output</div>
          <button class="win__close" data-close="win-depthout">✕</button>
        </header>
        <div class="win__body">
          <textarea id="depthOutput" placeholder="Paste the second-pass (Plain / Standard / Advanced) output here…"></textarea>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Notes -->
      <section class="win" id="win-notes" style="left:740px; top:720px; width:560px; height:200px;">
        <header class="win__head">
          <div class="win__title">Notes</div>
          <button class="win__close" data-close="win-notes">✕</button>
        </header>
        <div class="win__body">
          <textarea id="notes" placeholder="Scratchpad…"></textarea>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Waking Context Prompt -->
      <section class="win" id="win-wakeprompt" style="left:24px; top:1020px; width:680px;">
        <header class="win__head">
          <div class="win__title">Waking Context Prompt</div>
          <button class="win__close" data-close="win-wakeprompt">✕</button>
        </header>
        <div class="win__body">
          <label>Waking life context (free text)</label>
          <textarea id="wakingContext" placeholder="Add relevant waking-life details (e.g., current stresses, relationships, milestones)…"></textarea>

          <label style="display:block;margin-top:10px;">Prompt (auto-built from Model Output + Context)</label>
          <textarea id="wakePromptPreview" placeholder="Prompt will assemble here…" style="min-height:140px;"></textarea>
        </div>
        <div class="win__actions">
          <button class="btn" id="copyWakePrompt">Copy</button>
          <button class="btn" id="clearWake">Clear</button>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Waking Context Output -->
      <section class="win" id="win-wakeout" style="left:740px; top:1020px; width:560px; height:240px;">
        <header class="win__head">
          <div class="win__title">Waking Context Output (paste here)</div>
          <button class="win__close" data-close="win-wakeout">✕</button>
        </header>
        <div class="win__body">
          <textarea id="wakeOutput" placeholder="Paste the waking-life-inclusive interpretation here…"></textarea>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Library -->
      <section class="win" id="win-library" style="left:1080px; top:24px; width:520px; height:500px;">
        <header class="win__head">
          <div class="win__title">Library</div>
          <button class="win__close" data-close="win-library">✕</button>
        </header>
        <div class="win__body">
          <div class="win__actions" style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
            <button class="btn" id="libRefresh">Refresh</button>
          </div>

          <label>Saved Dreams</label>
          <div id="libraryList" style="background:var(--panel);border:1px solid var(--border);border-radius:10px; padding:6px; height:180px; overflow:auto;"></div>

          <div class="win__actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
            <button class="btn" id="libSaveDream">Save Dream</button>
            <button class="btn" id="libSaveInterp">Save Interpretation</button>
            <button class="btn" id="libSaveDepth">Save Depth Output</button>
            <button class="btn" id="libSaveWaking">Save Waking Output</button>
          </div>
          <div class="win__actions" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" id="libLoadDream">Load Dream</button>
            <button class="btn" id="libLoadInterp">Load Interpretation</button>
            <button class="btn" id="libLoadDepth">Load Depth Output</button>
            <button class="btn" id="libLoadWaking">Load Waking Output</button>
          </div>

          <div class="win__actions" style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn" id="libDelete">Delete Selected (dream folder)</button>
          </div>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Storage Log -->
      <section class="win" id="win-storage-log" style="left:1080px; top:540px; width:520px; height:320px;">
        <header class="win__head">
          <div class="win__title">Storage Log</div>
          <button class="win__close" data-close="win-storage-log">✕</button>
        </header>
        <div class="win__body">
          <textarea id="storageLog" placeholder="Log will appear here…" readonly style="min-height:220px;"></textarea>
          <div class="win__actions" style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn" id="logClear">Clear Log</button>
          </div>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>

      <!-- Settings -->
      <section class="win" id="win-settings" style="left:1080px; top:880px; width:520px; height:280px;">
        <header class="win__head">
          <div class="win__title">Settings</div>
          <button class="win__close" data-close="win-settings">✕</button>
        </header>
        <div class="win__body">
          <label>Storage Mode</label>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:8px;">
            <label><input type="radio" name="storageMode" value="auto" checked> Auto (OPFS if available, else IndexedDB)</label>
            <label><input type="radio" name="storageMode" value="folder"> Connected Folder (Directory Picker)</label>
            <label><input type="radio" name="storageMode" value="idb"> IndexedDB (fallback)</label>
          </div>
          <div class="win__actions" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" id="connectFolder">Connect Folder…</button>
            <button class="btn" id="revokeFolder">Disconnect</button>
            <button class="btn" id="openFolder" title="Open a folder just to inspect">Open Folder</button>
          </div>
          <div style="margin-top:8px;">
            <div class="note">Status:</div>
            <div id="storageStatus" class="note">Initializing…</div>
          </div>
        </div>
        <div class="resizer r-n"></div><div class="resizer r-s"></div>
        <div class="resizer r-e"></div><div class="resizer r-w"></div>
        <div class="resizer r-ne"></div><div class="resizer r-nw"></div>
        <div class="resizer r-se"></div><div class="resizer r-sw"></div>
      </section>
    </main>
  </div>

<div id="userBadge">User: Local</div>

<!-- Sidebar & Windows -->
<script>
const sidebar  = document.getElementById('sidebar');
const toggle   = document.getElementById('toggle');
const splitter = document.getElementById('splitter');

const LS = {
  collapsed: 'da_v44_sidebar_collapsed',
  width:     'da_v44_sidebar_w',
  prevWidth: 'da_v44_sidebar_prev_w',
  menuOrder: 'da_v44_menu_order',
  layout:    'da_v44_layout'
};

function setSidebarWidth(px){
  const min = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w-min'))||56;
  px = Math.max(min, px);
  document.documentElement.style.setProperty('--sidebar-w', px+'px');
  sidebar.style.width = px+'px';
  localStorage.setItem(LS.width, String(px));
}
toggle.addEventListener('click', ()=>{
  const goingCollapsed = !sidebar.classList.contains('collapsed');
  if(goingCollapsed){
    const curW = sidebar.getBoundingClientRect().width;
    localStorage.setItem(LS.prevWidth, String(curW));
    sidebar.classList.add('collapsed');
    setSidebarWidth(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w-min'))||56);
    localStorage.setItem(LS.collapsed,'1');
  }else{
    sidebar.classList.remove('collapsed');
    const prev = parseInt(localStorage.getItem(LS.prevWidth)||'0',10);
    const saved= parseInt(localStorage.getItem(LS.width)||'280',10);
    setSidebarWidth(prev || saved || 280);
    localStorage.setItem(LS.collapsed,'0');
  }
});
let sizingSide=false, sx=0, startW=0;
splitter.addEventListener('mousedown', (e)=>{
  if(sidebar.classList.contains('collapsed')) return;
  sizingSide=true; sx=e.clientX; startW=sidebar.getBoundingClientRect().width;
  document.body.style.userSelect='none';
});
window.addEventListener('mousemove', (e)=>{
  if(!sizingSide) return;
  const dx = e.clientX - sx;
  setSidebarWidth(startW + dx);
});
window.addEventListener('mouseup', ()=>{
  if(!sizingSide) return; sizingSide=false; document.body.style.userSelect='';
});

(function restoreSidebar(){
  const collapsed = localStorage.getItem(LS.collapsed)==='1';
  const savedW  = parseInt(localStorage.getItem(LS.width)||'280',10);
  const prevW   = parseInt(localStorage.getItem(LS.prevWidth)||'0',10);
  if(collapsed){
    sidebar.classList.add('collapsed');
    setSidebarWidth(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w-min'))||56);
  }else{
    setSidebarWidth(prevW || savedW || 280);
  }
})();

/* Menu */
const menu = document.getElementById('menu');
let dragSrc=null;
menu.addEventListener('dragstart', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  dragSrc = btn; e.dataTransfer.effectAllowed='move';
});
menu.addEventListener('dragover', e=>{
  e.preventDefault();
  const btn = e.target.closest('button'); if(!btn || btn===dragSrc) return;
  btn.classList.add('drag-over');
});
menu.addEventListener('dragleave', e=>{
  const btn = e.target.closest('button'); if(btn) btn.classList.remove('drag-over');
});
menu.addEventListener('drop', e=>{
  e.preventDefault();
  const btn = e.target.closest('button');
  if(btn && dragSrc && btn!==dragSrc){
    btn.classList.remove('drag-over');
    const kids=[...menu.children];
    const a=kids.indexOf(dragSrc), b=kids.indexOf(btn);
    if(a<b) menu.insertBefore(dragSrc, btn.nextSibling); else menu.insertBefore(dragSrc, btn);
    const order=[...menu.querySelectorAll('button')].map(b=>b.dataset.target);
    localStorage.setItem(LS.menuOrder, JSON.stringify(order));
  }
});
(function restoreMenu(){
  try{
    const saved = JSON.parse(localStorage.getItem(LS.menuOrder)||'[]');
    if(saved.length){
      const map = Object.fromEntries([...menu.children].map(el=>[el.dataset.target, el]));
      saved.forEach(id=> map[id] && menu.appendChild(map[id]));
    }
  }catch{}
})();
menu.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id  = btn.dataset.target;
  const win = document.getElementById(id);
  if(!win) return;
  const isHidden = getComputedStyle(win).display === 'none';
  if(isHidden){ win.style.display='flex'; bringToFront(win); }
  else{ win.style.display='none'; }
  updateMenuIndicator(id);
  saveLayout();
});
function updateMenuIndicator(winId){
  const btn = menu.querySelector(`button[data-target="${winId}"]`);
  const win = document.getElementById(winId);
  if(!btn || !win) return;
  const visible = getComputedStyle(win).display !== 'none';
  btn.classList.toggle('active', visible);
}

/* Windows */
const desktop = document.getElementById('desktop');
let z = 10;
function bringToFront(win){ win.style.zIndex = ++z; }
document.querySelectorAll('.win').forEach(win=>{
  bringToFront(win);
  win.querySelector('.win__close')?.addEventListener('click', (e)=>{
    const id = e.currentTarget.getAttribute('data-close');
    const w  = document.getElementById(id);
    if(w){ w.style.display='none'; updateMenuIndicator(id); saveLayout(); }
  });
  const head = win.querySelector('.win__head');
  let startX, startY, startLeft, startTop, dragging=false;
  head.addEventListener('mousedown', (e)=>{
    if(e.target.classList.contains('win__close')) return;
    dragging=true; bringToFront(win);
    startX=e.clientX; startY=e.clientY;
    const rect = win.getBoundingClientRect();
    const viewport = desktop.getBoundingClientRect();
    startLeft = rect.left - viewport.left + desktop.scrollLeft;
    startTop  = rect.top  - viewport.top  + desktop.scrollTop;
    function onMove(ev){
      if(!dragging) return;
      const dx = ev.clientX - startX, dy = ev.clientY - startY;
      win.style.left = (startLeft + dx) + 'px';
      win.style.top  = (startTop  + dy) + 'px';
    }
    function onUp(){ dragging=false; document.removeEventListener('mousemove', onMove); saveLayout(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp, {once:true});
    e.preventDefault();
  });
  const mins = {w:380, h:140};
  const resizers = win.querySelectorAll('.resizer');
  let sizing=false, sx=0, sy=0, sl=0, st=0, sw=0, sh=0, role='';
  resizers.forEach(r=>{
    r.addEventListener('mousedown', (e)=>{
      sizing=true; bringToFront(win);
      const rect = win.getBoundingClientRect();
      const vp   = desktop.getBoundingClientRect();
      sx=e.clientX; sy=e.clientY;
      sl = rect.left - vp.left + desktop.scrollLeft;
      st = rect.top  - vp.top  + desktop.scrollTop;
      sw = rect.width; sh = rect.height;
      role = [...r.classList].find(c=>c.startsWith('r-'));
      document.addEventListener('mousemove', onSize);
      document.addEventListener('mouseup', stopSize, {once:true});
      e.preventDefault();
    });
  });
  function onSize(e){
    if(!sizing) return;
    let dx = e.clientX - sx, dy = e.clientY - sy;
    let newL=sl, newT=st, newW=sw, newH=sh;
    if(role.includes('e')) newW = Math.max(mins.w, sw + dx);
    if(role.includes('s')) newH = Math.max(mins.h, sh + dy);
    if(role.includes('w')) { newW = Math.max(mins.w, sw - dx); newL = sl + dx; }
    if(role.includes('n')) { newH = Math.max(mins.h, sh - dy); newT = st + dy; }
    win.style.left = newL+'px'; win.style.top = newT+'px';
    win.style.width = newW+'px'; win.style.height = newH+'px';
  }
  function stopSize(){
    sizing=false; document.removeEventListener('mousemove', onSize); saveLayout();
  }
  win.addEventListener('mousedown', ()=> bringToFront(win));
});
function saveLayout(){
  const data = {};
  document.querySelectorAll('.win').forEach(w=>{
    data[w.id] = {
      left:w.style.left, top:w.style.top,
      width:w.style.width, height:w.style.height,
      z:w.style.zIndex, display:getComputedStyle(w).display
    };
  });
  localStorage.setItem(LS.layout, JSON.stringify(data));
}
(function restoreLayout(){
  try{
    const data = JSON.parse(localStorage.getItem(LS.layout)||'{}');
    Object.entries(data).forEach(([id,geo])=>{
      const w=document.getElementById(id); if(!w) return;
      Object.assign(w.style, {
        left:geo.left, top:geo.top, width:geo.width, height:geo.height, zIndex:geo.z
      });
      if(geo.display) w.style.display = geo.display;
      z = Math.max(z, parseInt(geo.z||10,10));
    });
  }catch{}
  document.querySelectorAll('.win').forEach(w=> updateMenuIndicator(w.id));
})();
</script>

<!-- Prompts -->
<script>
const frameworkSelect = document.getElementById('framework');
const dreamEl = document.getElementById('dream');
const promptPreview = document.getElementById('promptPreview');
const depthPrompt = document.getElementById('depthPrompt');

function buildFrameworkPrompt(){
  const fw = frameworkSelect.value;
  const dream = dreamEl.value.trim();
  const map = {
    'Jungian (v1)': `You are a Jungian dream analyst. Interpret the following dream using core Jungian concepts.
Keep the tone educational and exploratory, not therapeutic.
Do not include greetings or questions.
First, provide a clear **table** mapping each dream element to its Jungian interpretation.
Then, write a short section titled **Interpretation** that weaves the elements together into one coherent, easy-to-grasp whole.
End with a concluding insight, not a question.

Dream: [${dream}]`,
    'Freudian (v2)': `You are a Freudian dream analyst. Interpret the following dream using core Freudian concepts only.
Keep the tone educational and exploratory, not therapeutic.
Do not include greetings or questions.
First, provide a clear **table** mapping each dream element to its Freudian interpretation.
Then, write a section titled **Interpretation** that explains the dream as the disguised fulfillment of repressed wishes or conflicts.
Use clear and concise language that makes Freudian concepts accessible without losing depth.
Finally, add a short section titled **Concluding Insight** that summarizes the unconscious conflicts revealed.

Dream: [${dream}]`,
    'Gestalt (v3)': `You are a Gestalt dream analyst. Interpret the following dream using core Gestalt concepts.
Keep the tone educational and exploratory, not therapeutic.
Do not include greetings or questions.
First, provide a clear **table** mapping each dream element to its Gestalt interpretation.
Then, write a short section titled **Interpretation** that weaves the elements together into one coherent, easy-to-grasp whole.
End with a concluding insight, not a question.

Dream: [${dream}]`,
    'Shamanic (v1)': `You are a Shamanic dream analyst. Interpret the following dream using core Shamanic concepts.
Keep the tone educational and exploratory, not therapeutic.
Do not include greetings or questions.
First, provide a clear **table** mapping each dream element to its Shamanic interpretation.
Then, write a short section titled **Interpretation** that weaves the elements together into one coherent, easy-to-grasp whole.
End with a concluding insight, not a question.

Dream: [${dream}]`,
    'Cognitive/Neuropsych (v1)': `You are a Cognitive/Neuropsychological dream analyst. Interpret the following dream using core Cognitive/Neuropsych concepts.
Keep the tone educational and exploratory, not therapeutic.
Do not include greetings or questions.
First, provide a clear **table** mapping each dream element to its Cognitive/Neuropsychological interpretation.
Then, write a short section titled **Interpretation** that weaves the elements together into one coherent, easy-to-grasp whole.
End with a concluding insight, not a question.

Dream: [${dream}]`
  };
  return map[fw] || '';
}
function buildDepthPrompt(){
  return `Rephrase the following interpretation into one of three styles. Keep factual content identical.

Styles:
1) Plain Language — minimal jargon; short sentences; everyday words.
2) Standard — balanced clarity and depth; light terminology.
3) Advanced (Technical) — precise, theory-accurate terminology and structure.

Return only the rewritten text. Original begins after the line "-----".
-----`;
}
function refreshPrompts(){ promptPreview.value = buildFrameworkPrompt(); depthPrompt.value = buildDepthPrompt(); }
frameworkSelect.addEventListener('change', refreshPrompts);
dreamEl.addEventListener('input', refreshPrompts);
refreshPrompts();

function copyText(id){ const el=document.getElementById(id); el.select(); document.execCommand('copy'); }
document.getElementById('copyFrameworkPrompt').onclick = ()=> copyText('promptPreview');
document.getElementById('copyPrompt').onclick = ()=> copyText('promptPreview');
document.getElementById('copyDepth').onclick = ()=> copyText('depthPrompt');
document.getElementById('clearDream').onclick = ()=>{ dreamEl.value=''; refreshPrompts(); };
document.getElementById('clearDepth').onclick = ()=>{ depthPrompt.value = buildDepthPrompt(); };

function buildDepthPromptFromOutput(style){
  const src = (document.getElementById('modelOutput')?.value || '').trim();
  const styleLine = {
    plain:    'Plain Language — minimal jargon; short sentences; everyday words.',
    standard: 'Standard — balanced clarity and depth; light terminology.',
    advanced: 'Advanced (Technical) — precise, theory-accurate terminology and structure.'
  }[style] || 'Standard — balanced clarity and depth; light terminology.';
  return `Rewrite the following dream interpretation in ${styleLine}
Keep factual content identical. Do not add new material. Return only the rewritten text.

Original begins after the line "-----".
-----
${src || '—'}`;
}
document.getElementById('genDepthPlain')?.addEventListener('click', ()=>{
  const dp = document.getElementById('depthPrompt'); if(!dp) return;
  dp.value = buildDepthPromptFromOutput('plain');
  const w = document.getElementById('win-depth'); if (w) { w.style.display='flex'; w.style.zIndex=++z; }
});
document.getElementById('genDepthStandard')?.addEventListener('click', ()=>{
  const dp = document.getElementById('depthPrompt'); if(!dp) return;
  dp.value = buildDepthPromptFromOutput('standard');
  const w = document.getElementById('win-depth'); if (w) { w.style.display='flex'; w.style.zIndex=++z; }
});
document.getElementById('genDepthAdvanced')?.addEventListener('click', ()=>{
  const dp = document.getElementById('depthPrompt'); if(!dp) return;
  dp.value = buildDepthPromptFromOutput('advanced');
  const w = document.getElementById('win-depth'); if (w) { w.style.display='flex'; w.style.zIndex=++z; }
});

/* Waking Context */
const wakingContextEl   = document.getElementById('wakingContext');
const modelOutputEl     = document.getElementById('modelOutput');
const wakePromptPreview = document.getElementById('wakePromptPreview');
function buildWakingContextPrompt(){
  const ctx   = (wakingContextEl?.value || '').trim();
  const interp= (modelOutputEl?.value   || '').trim();
  return `Create a waking-life–informed revision of the dream interpretation.

Instructions:
- Start from the existing interpretation provided between <<<INTERPRETATION>>> markers.
- Integrate the waking-life context provided between [[CONTEXT]] markers wherever it clarifies motives, tensions, or symbols.
- Keep the same overall structure (Table of elements, then **Interpretation**, then **Concluding Insight**). If no table exists, produce one.
- Stay educational and exploratory, not therapeutic. Do not add greetings or questions. Avoid advice or directives.
- Maintain factual content from the original; only add context-aware links. Keep tone consistent with the framework.

[[CONTEXT]]
${ctx || '—'}
[[/CONTEXT]]

<<<INTERPRETATION>>>
${interp || '—'}
<<<END>>>`;
}
function refreshWakePrompt(){ if(wakePromptPreview) wakePromptPreview.value = buildWakingContextPrompt(); }
wakingContextEl?.addEventListener('input', refreshWakePrompt);
modelOutputEl?.addEventListener('input', refreshWakePrompt);
refreshWakePrompt();
document.getElementById('copyWakePrompt')?.addEventListener('click', ()=> copyText('wakePromptPreview'));
document.getElementById('clearWake')?.addEventListener('click', ()=>{
  if(wakingContextEl) wakingContextEl.value='';
  if(wakePromptPreview) wakePromptPreview.value = buildWakingContextPrompt();
});
</script>

<!-- Storage adapters + Profiles library -->
<script>
(function(){
  const LOG = (msg) => {
    const el = document.getElementById('storageLog'); if(!el) return;
    const t = new Date().toISOString().replace('T',' ').replace('Z','');
    el.value += `[${t}] ${msg}\n`; el.scrollTop = el.scrollHeight;
  };
  const setStatus = (txt) => { const s = document.getElementById('storageStatus'); if(s) s.textContent = txt; };

  /* Tiny IndexedDB KV for handles & manifests */
  const idb = (() => {
    const DB='DreamAppDB_v1', STORE='kv';
    function open(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB,1); r.onupgradeneeded=()=>r.result.createObjectStore(STORE); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
    async function put(k,v){ const db=await open(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(v,k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    async function get(k){ const db=await open(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).get(k); req.onsuccess=()=>res(req.result??null); req.onerror=()=>rej(req.error); }); }
    async function del(k){ const db=await open(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    return { put, get, del };
  })();

  const segs = (p)=>p.split('/').filter(Boolean);

  /* Adapters with listDirs */
  const OPFS = {
    name:'opfs',
    async root(){ return await navigator.storage.getDirectory(); },
    async ensureDir(path){ let d=await this.root(); for(const s of segs(path)) d = await d.getDirectoryHandle(s,{create:true}); return d; },
    async put(path,data){ const a=segs(path), f=a.pop(); const d=await this.ensureDir(a.join('/')); const fh=await d.getFileHandle(f,{create:true}); const w=await fh.createWritable(); await w.write(typeof data==='string'?data:JSON.stringify(data,null,2)); await w.close(); LOG('OPFS saved: '+path); },
    async get(path){ const a=segs(path), f=a.pop(); let d=await this.root(); for(const s of a) d=await d.getDirectoryHandle(s); const fh=await d.getFileHandle(f); const txt=await (await fh.getFile()).text(); try{ return JSON.parse(txt); }catch{ return txt; } },
    async remove(path){ const a=segs(path), f=a.pop(); let d=await this.root(); for(const s of a) d=await d.getDirectoryHandle(s); try{ await d.removeEntry(f,{recursive:true}); }catch{ try{ await d.removeEntry(f); }catch{} } LOG('OPFS removed: '+path); },
    async listDirs(dir){ let d=await this.root(); for(const s of segs(dir)) d=await d.getDirectoryHandle(s,{create:true}); const out=[]; for await (const [n,h] of d.entries()) if(h.kind==='directory') out.push(n); return out; },
    async listFiles(dir){ let d=await this.root(); for(const s of segs(dir)) d=await d.getDirectoryHandle(s,{create:true}); const out=[]; for await (const [n,h] of d.entries()) if(h.kind==='file') out.push(n); return out; }
  };
  const FOLDER = {
    name:'folder', handle:null,
    async connect(){ this.handle = await window.showDirectoryPicker({ id:'DreamApp', mode:'readwrite' }); await idb.put('folderHandle', this.handle); return true; },
    async restore(){ const h = await idb.get('folderHandle'); if(h) this.handle = h; return !!this.handle; },
    async ensureDir(path){ let d=this.handle; if(!d) throw new Error('No folder'); for(const s of segs(path)) d = await d.getDirectoryHandle(s,{create:true}); return d; },
    async put(path,data){ const a=segs(path), f=a.pop(); const d=await this.ensureDir(a.join('/')); const fh=await d.getFileHandle(f,{create:true}); const w=await fh.createWritable(); await w.write(typeof data==='string'?data:JSON.stringify(data,null,2)); await w.close(); LOG('Folder saved: '+path); },
    async get(path){ const a=segs(path), f=a.pop(); let d=this.handle; if(!d) throw new Error('No folder'); for(const s of a) d=await d.getDirectoryHandle(s); const fh=await d.getFileHandle(f); const txt=await (await fh.getFile()).text(); try{ return JSON.parse(txt); }catch{ return txt; } },
    async remove(path){ const a=segs(path), f=a.pop(); let d=this.handle; for(const s of a) d=await d.getDirectoryHandle(s); try{ await d.removeEntry(f,{recursive:true}); }catch{ try{ await d.removeEntry(f); }catch{} } LOG('Folder removed: '+path); },
    async listDirs(dir){ let d=this.handle; if(!d) throw new Error('No folder'); for(const s of segs(dir)) d=await d.getDirectoryHandle(s,{create:true}); const out=[]; for await (const [n,h] of d.entries()) if(h.kind==='directory') out.push(n); return out; },
    async listFiles(dir){ let d=this.handle; if(!d) throw new Error('No folder'); for(const s of segs(dir)) d=await d.getDirectoryHandle(s,{create:true}); const out=[]; for await (const [n,h] of d.entries()) if(h.kind==='file') out.push(n); return out; }
  };
  const IDB = {
    name:'idb',
    async put(path,data){
      const key='file:'+path, txt=typeof data==='string'?data:JSON.stringify(data,null,2);
      await idb.put(key, txt);
      const dir=segs(path).slice(0,-1).join('/'); const leaf=segs(path).slice(-2,-1)[0];
      const dirKey='dir:'+dir;
      const list = (await idb.get(dirKey))||[];
      if(!list.includes(leaf)) list.push(leaf);
      await idb.put(dirKey, list);
      LOG('IDB saved: '+path);
    },
    async get(path){ const txt = await idb.get('file:'+path); if(!txt) return null; try{ return JSON.parse(txt); }catch{ return txt; } },
    async remove(path){ await idb.del('file:'+path); LOG('IDB removed: '+path); },
    async listDirs(dir){ return (await idb.get('dir:'+dir))||[]; },
    async listFiles(){ return []; }
  };

  /* FS facade */
  const FS = {
    mode:'auto', adapter:null,
    async init(){
      const hasOPFS = !!(navigator.storage && navigator.storage.getDirectory);
      const hasPicker = !!window.showDirectoryPicker;
      if(this.mode==='folder' && hasPicker){
        const ok = await FOLDER.restore().catch(()=>false);
        if(ok){ this.adapter=FOLDER; setStatus('Connected Folder'); return; }
      }
      if(this.mode==='folder' && !FOLDER.handle){ setStatus('No folder connected'); }
      if((this.mode==='auto') && hasOPFS){ this.adapter=OPFS; setStatus('OPFS'); try{ await navigator.storage.persist(); }catch{} return; }
      if(this.mode==='idb' || !hasOPFS){ this.adapter=IDB; setStatus('IndexedDB'); return; }
      // default
      this.adapter=IDB; setStatus('IndexedDB');
    },
    setMode(m){ this.mode=m; },
    put(p,d){ return this.adapter.put(p,d); },
    get(p){ return this.adapter.get(p); },
    remove(p){ return this.adapter.remove(p); },
    listDirs(p){ return this.adapter.listDirs(p); },
    listFiles(p){ return this.adapter.listFiles(p); },
    async connectFolder(){ await FOLDER.connect(); this.mode='folder'; this.adapter=FOLDER; setStatus('Connected Folder'); }
  };
  window.DA_FS = FS; // debug

  /* Profiles */
  const qs = (s,r=document)=>r.querySelector(s);
  const slug = (s)=> (s||'').toLowerCase().trim()
    .replace(/[^a-z0-9\s_-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').slice(0,80) || 'untitled';

  function userName(){
    const h = FOLDER.handle;
    return h ? (h.name || 'Folder') : 'Local';
  }
  function userBase(){ return `profiles/${userName()}`; }

  function ensureUserBadge(){ const b=document.getElementById('userBadge'); if(b) b.textContent='User: '+userName(); }

  async function refreshLibrary(){
    const listEl = document.getElementById('libraryList'); if(!listEl) return;
    listEl.innerHTML='Loading…';
    let names = await FS.listDirs(`${userBase()}/dreams`).catch(()=>[]);
    names = (names||[]).sort();
    if(!names.length){ listEl.innerHTML='<em>No dreams saved yet.</em>'; return; }
    listEl.innerHTML = names.map(n=>`<label style="display:flex;gap:6px;align-items:center;padding:4px 0;"><input type="radio" name="dreamPick" value="${n}"> <span>${n}</span></label>`).join('');
  }
  function pickSlug(){ const r=document.querySelector('input[name="dreamPick"]:checked'); return r? r.value : null; }

  const payloads = {
    dream: (name, text)=>({ name, text, updatedAt:new Date().toISOString() }),
    interpretation: (name, text)=>({ name, interpretation:text, updatedAt:new Date().toISOString() }),
    depth: (name, text)=>({ name, depthOutput:text, updatedAt:new Date().toISOString() }),
    waking: (name, text)=>({ name, wakingOutput:text, updatedAt:new Date().toISOString() })
  };

  async function save(kind){
    const name = slug(qs('#dreamName')?.value || pickSlug());
    const map = {
      dream: { el: '#dream', path: (n)=>`${userBase()}/dreams/${n}/dream.json` },
      interpretation: { el: '#modelOutput', path: (n)=>`${userBase()}/dreams/${n}/interpretation.json` },
      depth: { el: '#depthOutput', path: (n)=>`${userBase()}/dreams/${n}/depth.json` },
      waking: { el: '#wakeOutput', path: (n)=>`${userBase()}/dreams/${n}/waking.json` },
    }[kind];
    const text = qs(map.el)?.value?.trim()||'';
    if(!name || !text){ LOG(`Save ${kind}: need dream name + text`); return; }
    await FS.put(map.path(name), payloads[kind](name, text));
    LOG(`Saved ${kind} → ${name}`);
    refreshLibrary();
  }

  async function load(kind){
    const name = slug(pickSlug() || qs('#dreamName')?.value);
    if(!name){ LOG(`Load ${kind}: select a dream in Library or enter name`); return; }
    const path = `${userBase()}/dreams/${name}/${kind==='dream'?'dream':kind}.json`;
    const data = await FS.get(path).catch(()=>null);
    if(!data){ LOG('Nothing loaded'); return; }
    if(kind==='dream'){ qs('#dream') && (qs('#dream').value = data.text||''); qs('#dreamName') && (qs('#dreamName').value = data.name||name); }
    if(kind==='interpretation'){ qs('#modelOutput') && (qs('#modelOutput').value = data.interpretation||''); }
    if(kind==='depth'){ qs('#depthOutput') && (qs('#depthOutput').value = data.depthOutput||''); }
    if(kind==='waking'){ qs('#wakeOutput') && (qs('#wakeOutput').value = data.wakingOutput||''); }
    LOG(`Loaded ${kind} ← ${name}`);
  }

  async function deleteDream(){
    const name = pickSlug();
    if(!name){ LOG('Delete: pick a dream'); return; }
    const base = `${userBase()}/dreams/${name}`;
    // Try recursive remove of folder first; if it fails, remove known files
    try{
      await FS.remove(base);
    }catch{
      await FS.remove(`${base}/dream.json`).catch(()=>{});
      await FS.remove(`${base}/interpretation.json`).catch(()=>{});
      await FS.remove(`${base}/depth.json`).catch(()=>{});
      await FS.remove(`${base}/waking.json`).catch(()=>{});
    }
    LOG('Deleted dream folder: '+name);
    refreshLibrary();
  }

  function wireUI(){
    document.getElementById('libRefresh')?.addEventListener('click', refreshLibrary);
    document.getElementById('libSaveDream')?.addEventListener('click', ()=>save('dream'));
    document.getElementById('libSaveInterp')?.addEventListener('click', ()=>save('interpretation'));
    document.getElementById('libSaveDepth')?.addEventListener('click', ()=>save('depth'));
    document.getElementById('libSaveWaking')?.addEventListener('click', ()=>save('waking'));
    document.getElementById('libLoadDream')?.addEventListener('click', ()=>load('dream'));
    document.getElementById('libLoadInterp')?.addEventListener('click', ()=>load('interpretation'));
    document.getElementById('libLoadDepth')?.addEventListener('click', ()=>load('depth'));
    document.getElementById('libLoadWaking')?.addEventListener('click', ()=>load('waking'));
    document.getElementById('libDelete')?.addEventListener('click', deleteDream);
    document.getElementById('logClear')?.addEventListener('click', ()=>{ const el=document.getElementById('storageLog'); if(el) el.value=''; });

    // Settings
    const radios = document.querySelectorAll('input[name="storageMode"]');
    radios.forEach(r => r.addEventListener('change', async () => {
      FS.setMode(r.value);
      await FS.init();
      ensureUserBadge();
      refreshLibrary();
    }));
    document.getElementById('connectFolder')?.addEventListener('click', async ()=>{
      try{ await FS.connectFolder(); ensureUserBadge(); refreshLibrary(); LOG('Connected to folder'); }
      catch(e){ LOG('Folder connect canceled/failed'); }
    });
    document.getElementById('revokeFolder')?.addEventListener('click', async ()=>{
      await idb.del('folderHandle'); FOLDER.handle=null; FS.setMode('auto'); await FS.init(); ensureUserBadge(); refreshLibrary(); LOG('Disconnected folder handle');
    });
    document.getElementById('openFolder')?.addEventListener('click', async ()=>{
      try{ const h = await window.showDirectoryPicker({ id:'DreamApp', mode:'read' }); LOG('Folder opened (read-only check): '+(h.name||'selected')); }
      catch(e){ LOG('Open folder canceled'); }
    });
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    await FS.init();
    ensureUserBadge();
    wireUI();
    refreshLibrary();
    LOG('Storage ready: '+(FS.adapter && FS.adapter.name));
  });
})();
</script>
</body>
</html>
