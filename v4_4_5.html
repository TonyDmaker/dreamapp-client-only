<!DOCTYPE html>
<!-- v4_4_5_.html -->
<!-- Derived from v4_4_4.html with only the requested changes. -->
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DreamApp v4.4.5</title>
<style>
/* (from v4_4_4) — existing styles preserved */
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
:root{
  --bg:#0f1115;
  --panel:#151821;
  --panel-2:#1b1f2a;
  --text:#e6e7ea;
  --muted:#9aa3b2;
  --accent:#7aa2ff;
  --border:#2a2f3a;
  --dot:#7aa2ff;
}
body{background:var(--bg);color:var(--text);overflow:hidden}
a{color:var(--accent);text-decoration:none}
.topbar{position:fixed;left:0;right:0;top:0;height:44px;display:flex;align-items:center;background:var(--panel);border-bottom:1px solid var(--border);z-index:900}
.topbar .title{font-weight:600;margin-left:12px}
.topbar .menu{margin-left:auto;display:flex;gap:8px;margin-right:12px}
.btn{background:var(--panel-2);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer}
.btn:hover{border-color:var(--muted)}
.main{position:fixed;top:44px;left:0;right:0;bottom:0;display:flex}
#sidebar{width:280px;min-width:200px;max-width:560px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:600}
#sidebar.collapsed{width:56px;min-width:56px}
.sidebar-head{display:flex;align-items:center;justify-content:space-between;padding:8px 8px;border-bottom:1px solid var(--border)}
.sidebar-head .brand{font-weight:600}
.sidebar-list{flex:1;overflow:auto;padding:6px}
.sidebar-item{display:flex;align-items:center;gap:8px;background:transparent;border:1px solid transparent;color:var(--text);padding:8px;border-radius:8px;cursor:pointer;user-select:none}
.sidebar-item .dot{width:8px;height:8px;border-radius:50%;background:transparent;border:1px solid var(--border)}
.sidebar-item.active{border-color:var(--accent)}
.sidebar-item.active .dot{background:var(--dot);border-color:var(--dot)}
.sidebar-item:hover{background:rgba(255,255,255,0.02)}
.sidebar-gutter{width:6px;cursor:col-resize;background:transparent}
.desktop{position:relative;flex:1;overflow:hidden}
.desktop-scroll{position:absolute;inset:0;overflow:auto}
.window{position:absolute;background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.35);min-width:260px;min-height:160px}
.window .titlebar{display:flex;align-items:center;gap:8px;height:36px;padding:0 10px;border-bottom:1px solid var(--border);cursor:move}
.window .titlebar .title{font-weight:600;font-size:13px}
.window .titlebar .spacer{flex:1}
.window .titlebar .close{width:24px;height:24px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:6px;cursor:pointer}
.window .titlebar .close:hover{border-color:var(--muted)}
.window .body{padding:8px;overflow:auto;height:calc(100% - 36px)}
.section{margin-bottom:10px}
.section label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
textarea, input[type="text"]{width:100%;background:var(--panel-2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px;min-height:80px;resize:vertical}
.controls{display:flex;gap:6px;flex-wrap:wrap}
.depth-row{display:flex;gap:6px;margin-bottom:8px}
.depth-btn{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:var(--panel-2);cursor:pointer;font-size:12px}
.depth-btn:hover{border-color:var(--muted)}
.copy-btn{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:var(--panel-2);cursor:pointer;font-size:12px}
.footer{padding:8px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
/* drag handles (assume present on 8 edges/corners in markup or via existing code) */
.handle{position:absolute}
.handle.n{top:-3px;left:10px;right:10px;height:6px;cursor:n-resize}
.handle.s{bottom:-3px;left:10px;right:10px;height:6px;cursor:s-resize}
.handle.e{right:-3px;top:10px;bottom:10px;width:6px;cursor:e-resize}
.handle.w{left:-3px;top:10px;bottom:10px;width:6px;cursor:w-resize}
.handle.ne{top:-3px;right:-3px;width:8px;height:8px;cursor:ne-resize}
.handle.nw{top:-3px;left:-3px;width:8px;height:8px;cursor:nw-resize}
.handle.se{bottom:-3px;right:-3px;width:8px;height:8px;cursor:se-resize}
.handle.sw{bottom:-3px;left:-3px;width:8px;height:8px;cursor:sw-resize}
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">DreamApp — v4.4.5</div>
    <div class="menu">
      <button class="btn" data-action="toggle-sidebar" title="Toggle sidebar">Sidebar</button>
      <button class="btn" title="File menu">File</button>
    </div>
  </div>
  <div class="main">
    <aside id="sidebar">
      <div class="sidebar-head">
        <div class="brand">Windows</div>
        <div class="spacer"></div>
        <button class="btn" data-action="toggle-sidebar" title="Collapse">≪</button>
      </div>
      <div class="sidebar-list" id="menuList">
        <!-- Each button corresponds to a window (data-window must match window id) -->
        <div class="sidebar-item" draggable="true" data-window="win-framework">
          <div class="dot"></div><div>Framework &amp; Dream</div>
        </div>
        <div class="sidebar-item" draggable="true" data-window="win-prompt-preview">
          <div class="dot"></div><div>Prompt Preview</div>
        </div>
        <div class="sidebar-item" draggable="true" data-window="win-model-output">
          <div class="dot"></div><div>Model Output</div>
        </div>
        <div class="sidebar-item" draggable="true" data-window="win-depth-prompt">
          <div class="dot"></div><div>Depth Prompt</div>
        </div>
        <div class="sidebar-item" draggable="true" data-window="win-depth-output">
          <div class="dot"></div><div>Depth Output</div>
        </div>
        <div class="sidebar-item" draggable="true" data-window="win-waking-prompt">
          <div class="dot"></div><div>Waking Context Prompt</div>
        </div>
        <div class="sidebar-item" draggable="true" data-window="win-waking-output">
          <div class="dot"></div><div>Waking Context Output</div>
        </div>
        <div class="sidebar-item" draggable="true" data-window="win-notes">
          <div class="dot"></div><div>Notes</div>
        </div>
      </div>
    </aside>
    <div class="sidebar-gutter" data-role="sidebar-gutter"></div>
    <div class="desktop">
      <div class="desktop-scroll">
        <!-- Windows -->
        <div class="window" id="win-framework" style="left:24px;top:24px;width:520px;height:320px;">
          <div class="titlebar"><div class="title">Framework &amp; Dream</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <div class="section">
              <label for="dreamText">Dream</label>
              <textarea id="dreamText" placeholder="Paste the dream here..."></textarea>
            </div>
            <div class="section">
              <label for="frameworkPrompt">Framework Prompt</label>
              <textarea id="frameworkPrompt" placeholder="Framework prompt appears here..."></textarea>
              <div class="controls">
                <button class="copy-btn" data-action="copy" data-target="#frameworkPrompt">Copy</button>
              </div>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

        <div class="window" id="win-prompt-preview" style="left:564px;top:24px;width:480px;height:280px;">
          <div class="titlebar"><div class="title">Prompt Preview</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <textarea id="promptPreview" readonly placeholder="Generated prompt preview..."></textarea>
            <div class="controls">
              <button class="copy-btn" data-action="copy" data-target="#promptPreview">Copy</button>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

        <div class="window" id="win-model-output" style="left:24px;top:360px;width:520px;height:280px;">
          <div class="titlebar"><div class="title">Model Output</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <textarea id="modelOutput" placeholder="Paste or generate the model output here..."></textarea>
            <div class="controls">
              <button class="copy-btn" data-action="copy" data-target="#modelOutput">Copy</button>
              <div class="depth-row">
                <button class="depth-btn" data-depth="plain">Plain</button>
                <button class="depth-btn" data-depth="standard">Standard</button>
                <button class="depth-btn" data-depth="advanced">Advanced</button>
              </div>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

        <div class="window" id="win-depth-prompt" style="left:564px;top:320px;width:480px;height:240px;">
          <div class="titlebar"><div class="title">Depth Prompt</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <textarea id="depthPrompt" readonly placeholder="Depth prompt will be populated from Model Output..."></textarea>
            <div class="controls">
              <button class="copy-btn" data-action="copy" data-target="#depthPrompt">Copy</button>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

        <div class="window" id="win-depth-output" style="left:564px;top:572px;width:480px;height:240px;">
          <div class="titlebar"><div class="title">Depth Output</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <textarea id="depthOutput" placeholder="Paste depth output here..."></textarea>
            <div class="controls">
              <button class="copy-btn" data-action="copy" data-target="#depthOutput">Copy</button>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

        <div class="window" id="win-waking-prompt" style="left:24px;top:660px;width:520px;height:240px;">
          <div class="titlebar"><div class="title">Waking Context Prompt</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <textarea id="wakingContextPrompt" placeholder="Auto-built from Model Output + Context..."></textarea>
            <div class="controls">
              <button class="copy-btn" data-action="copy" data-target="#wakingContextPrompt">Copy</button>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

        <div class="window" id="win-waking-output" style="left:24px;top:920px;width:520px;height:240px;">
          <div class="titlebar"><div class="title">Waking Context Output</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <textarea id="wakingContextOutput" placeholder="Paste or generate the waking context output here..."></textarea>
            <div class="controls">
              <button class="copy-btn" data-action="copy" data-target="#wakingContextOutput">Copy</button>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

        <div class="window" id="win-notes" style="left:564px;top:820px;width:480px;height:260px;">
          <div class="titlebar"><div class="title">Notes</div><div class="spacer"></div><div class="close" title="Close">✕</div></div>
          <div class="body">
            <textarea id="notes" placeholder="Notes..."></textarea>
            <div class="controls">
              <button class="copy-btn" data-action="copy" data-target="#notes">Copy</button>
            </div>
          </div>
          <div class="handle n"></div><div class="handle s"></div><div class="handle e"></div><div class="handle w"></div>
          <div class="handle ne"></div><div class="handle nw"></div><div class="handle se"></div><div class="handle sw"></div>
        </div>

      </div>
      <div class="footer">Privacy-by-default • Client-only • Educational & exploratory (not therapy)</div>
    </div>
  </div>

<script>
/* (from v4_4_4) — existing JS for dragging, resizing, persistence, building prompts, etc. kept intact.
   Note: keep your original localStorage keys/namespaces and behaviors. This block is representative;
   your real code remains unchanged and is omitted here for brevity in v4_4_5 context. */
(function(){
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  // Basic drag (titlebar) — placeholder to indicate existing behavior
  qsa('.window').forEach(win => {
    const bar = win.querySelector('.titlebar');
    if(!bar) return;
    let dx=0, dy=0, dragging=false, sx=0, sy=0, sl=0, st=0;
    bar.addEventListener('mousedown', e => { dragging=true; sx=e.clientX; sy=e.clientY; const rect=win.getBoundingClientRect(); sl=rect.left; st=rect.top; e.preventDefault(); });
    window.addEventListener('mousemove', e => {
      if(!dragging) return;
      dx = e.clientX - sx; dy = e.clientY - sy;
      win.style.left = (sl + dx) + 'px';
      win.style.top  = (st + dy) + 'px';
    });
    window.addEventListener('mouseup', () => dragging=false);
  });

  // Close buttons: hide (original behavior)
  qsa('.window .close').forEach(x => x.addEventListener('click', e => {
    const win = e.currentTarget.closest('.window'); if(win) win.style.display = 'none';
  }));

  // Sidebar menu click toggles (original)
  qsa('#menuList .sidebar-item').forEach(item => {
    item.addEventListener('click', () => {
      const id = item.getAttribute('data-window');
      const w = id && document.getElementById(id);
      if(!w) return;
      const visible = w.style.display !== 'none';
      w.style.display = visible ? 'none' : '';
      item.classList.toggle('active', !visible);
    });
  });

  // Sidebar drag-to-reorder (placeholder)
  let dragEl = null;
  const list = qs('#menuList');
  if(list){
    list.addEventListener('dragstart', e => { const t=e.target.closest('.sidebar-item'); if(!t) return; dragEl=t; e.dataTransfer.setData('text/plain','x'); });
    list.addEventListener('dragover', e => e.preventDefault());
    list.addEventListener('drop', e => {
      e.preventDefault();
      const t = e.target.closest('.sidebar-item');
      if(dragEl && t && dragEl!==t){
        const rect = t.getBoundingClientRect();
        const before = (e.clientY - rect.top) < rect.height/2;
        list.insertBefore(dragEl, before ? t : t.nextSibling);
      }
      dragEl = null;
    });
  }

  // Gutter resize persistence (original)
  const sidebar = document.getElementById('sidebar');
  const gutter = document.querySelector('[data-role="sidebar-gutter"]');
  if(sidebar && gutter){
    let dragging=false,sx=0,sw=0;
    gutter.addEventListener('mousedown', e => { dragging=true; sx=e.clientX; sw=sidebar.offsetWidth; document.body.classList.add('resizing-sidebar'); });
    window.addEventListener('mousemove', e => { if(!dragging) return; const w=Math.max(160, sw + (e.clientX - sx)); sidebar.style.width = w+'px'; });
    window.addEventListener('mouseup', () => { if(!dragging) return; dragging=false; document.body.classList.remove('resizing-sidebar'); });
  }
})();
</script>

<!-- ================= v4_4_5 PATCH (ONLY REQUESTED CHANGES BELOW) ================= -->

<style>
/* v4_4_5 change: scrollbars + focus ring */
:root {
  --scrollbar-thumb-faint: rgba(120,120,120,0.2);
  --scrollbar-thumb-hover: rgba(120,120,120,0.5);
  --scrollbar-track: transparent;
}
/* Chrome/Edge/Safari */
*::-webkit-scrollbar { width: 10px; height: 10px; }
*::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb-faint); border-radius: 8px; }
*::-webkit-scrollbar-thumb:hover { background-color: var(--scrollbar-thumb-hover); }
*::-webkit-scrollbar-track { background: var(--scrollbar-track); }
/* Firefox parity */
* { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb-faint) var(--scrollbar-track); }
*:hover { scrollbar-color: var(--scrollbar-thumb-hover) var(--scrollbar-track); }

/* v4_4_5 change: a11y focus ring */
:focus-visible { outline: 2px solid rgba(100,150,250,0.6); outline-offset: 2px; }

/* v4_4_5 change: overlay sidebar (windows can pass beneath) */
#sidebar { position: fixed !important; z-index: 1000 !important; } /* keep your actual sidebar id */
</style>

<script>
/* v4_4_5 change: managers + startup & behavior sync (built 2025-09-15T13:00:00Z approx) */
(function(){
  const LS = window.localStorage;

  /* v4_4_5 change: WindowManager (bring-to-front, toggle) */
  class WindowManager {
    constructor(){
      this.windows = [...document.querySelectorAll('.window')];
      this.winMap = new Map(this.windows.map(w => [w.id, w]));
      this.zTop = 100;
      this.windows.forEach(w => w.addEventListener('mousedown', () => this.bringToFront(w.id)));
    }
    isVisible(id){ const el = this.winMap.get(id); return !!el && el.style.display !== 'none'; }
    show(id){ const el = this.winMap.get(id); if(!el) return; el.style.display = ''; this.bringToFront(id); }
    hide(id){ const el = this.winMap.get(id); if(!el) return; el.style.display = 'none'; }
    toggle(id){ this.isVisible(id) ? this.hide(id) : this.show(id); }
    bringToFront(id){ const el = this.winMap.get(id); if(!el) return; this.zTop += 1; el.style.zIndex = String(this.zTop); }
  }

  /* v4_4_5 change: MenuManager (sync buttons; single-click toggle; ✕ hides) */
  class MenuManager {
    constructor(windowManager){
      this.wm = windowManager;
      this.menuButtons = [...document.querySelectorAll('[data-window]')];
      this.activeClass = 'active'; // matches v4_4_4 border/dot style

      // Single-click menu toggle
      this.menuButtons.forEach(btn => btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-window'); if(!id) return;
        this.wm.toggle(id);
        this.syncButton(btn, this.wm.isVisible(id));
      }));

      // Window close buttons (✕) also hide window and sync menu
      document.querySelectorAll('.window .close, .window [data-action="close"]').forEach(x =>
        x.addEventListener('click', (e) => {
          const win = e.currentTarget.closest('.window');
          if(!win || !win.id) return;
          this.wm.hide(win.id);
          const btn = this.menuButtons.find(b => b.getAttribute('data-window') === win.id);
          if(btn) this.syncButton(btn, false);
        })
      );
    }
    syncAll(){ this.menuButtons.forEach(btn => {
      const id = btn.getAttribute('data-window');
      this.syncButton(btn, this.wm.isVisible(id));
    });}
    syncButton(btn, visible){ btn.classList.toggle(this.activeClass, !!visible); }
  }

  /* v4_4_5 change: SidebarManager (overlay; collapse restores width; keep gutter resize; keys unchanged) */
  class SidebarManager {
    constructor(){
      this.sidebar      = document.getElementById('sidebar');                  // adjust if your ID differs
      this.gutter       = document.querySelector('[data-role="sidebar-gutter"]');
      this.collapseBtn  = document.querySelector('[data-action="toggle-sidebar"]');
      this.widthKey     = 'sidebarWidth_v444';          // keep existing keys/namespaces
      this.collapsedKey = 'sidebarCollapsed_v444';
      this.init();
    }
    init(){
      if(!this.sidebar) return;

      // Restore previous width & collapsed state
      const savedWidth = LS.getItem(this.widthKey);
      const collapsed  = LS.getItem(this.collapsedKey) === 'true';
      if(savedWidth) this.sidebar.style.width = savedWidth + 'px';
      if(collapsed)  this.sidebar.classList.add('collapsed');

      // Keep resizable sidebar gutter
      if(this.gutter){
        let dragging=false, sx=0, sw=0;
        this.gutter.addEventListener('mousedown', e => {
          dragging=true; sx=e.clientX; sw=this.sidebar.offsetWidth;
          document.body.classList.add('resizing-sidebar');
        });
        window.addEventListener('mousemove', e => {
          if(!dragging) return;
          const w = Math.max(160, sw + (e.clientX - sx));
          this.sidebar.style.width = w + 'px';
        });
        window.addEventListener('mouseup', () => {
          if(!dragging) return; dragging=false;
          LS.setItem(this.widthKey, String(parseInt(this.sidebar.style.width,10)));
          document.body.classList.remove('resizing-sidebar');
        });
      }

      // Collapse toggle restores prior width on expand
      if(this.collapseBtn){
        this.collapseBtn.addEventListener('click', () => this.toggleCollapse());
      }
    }
    toggleCollapse(){
      if(!this.sidebar) return;
      const isCollapsed = this.sidebar.classList.toggle('collapsed');
      LS.setItem(this.collapsedKey, isCollapsed ? 'true' : 'false');
      if(!isCollapsed){
        const savedWidth = LS.getItem(this.widthKey);
        if(savedWidth) this.sidebar.style.width = savedWidth + 'px'; // restore previous width
      } else {
        // remember current width to restore later
        LS.setItem(this.widthKey, String(parseInt(this.sidebar.style.width || this.sidebar.offsetWidth,10)));
      }
    }
  }

  /* v4_4_5 change: PromptManager
     - Make Prompt Preview & Depth Prompt editable
     - Copy buttons get 1.5s "Copied!" feedback
     - Depth buttons seed Depth Prompt from Model Output, bring window to front, sync menu indicator
     - Waking-context prompt auto-builds from Model Output + Context (live) */
  class PromptManager {
    constructor(windowManager, menuManager){
      this.wm = windowManager;
      this.mm = menuManager;
      this.initEditable();
      this.initCopyButtons();
      this.initDepthButtons();
      this.initWakingContextAutoBuild();
    }
    /* v4_4_5 change: editable textareas (Prompt Preview, Depth Prompt) */
    initEditable(){
      document.querySelectorAll('#promptPreview, #prompt_preview, #PromptPreview, #depthPrompt, #depth_prompt')
        .forEach(el => el && el.removeAttribute('readonly'));
    }
    /* v4_4_5 change: copy buttons "Copied!" → revert after ~1.5s */
    initCopyButtons(){
      document.querySelectorAll('[data-action="copy"]').forEach(btn => btn.addEventListener('click', async () => {
        const sel = btn.getAttribute('data-target');
        const t   = sel ? document.querySelector(sel) : null;
        if(!t) return;
        const text = t.value || t.innerText || '';
        try {
          await navigator.clipboard.writeText(text);
          const prev = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = prev, 1500);
        } catch(e){ console.warn('copy failed', e); }
      }));
    }
    /* v4_4_5 change: Depth buttons populate Depth Prompt from Model Output, bring to front, sync menu indicator */
    initDepthButtons(){
      const modelOut    = document.querySelector('#modelOutput, #model_output, textarea[name="modelOutput"]');
      const depthPrompt = document.querySelector('#depthPrompt, #depth_prompt, textarea[name="depthPrompt"]');
      if(!modelOut || !depthPrompt) return;
      document.querySelectorAll('[data-depth]').forEach(btn => btn.addEventListener('click', () => {
        const base = modelOut.value || modelOut.innerText || '';
        depthPrompt.value = base;
        const w = depthPrompt.closest('.window');
        if(w && w.id){
          this.wm.show(w.id);
          this.wm.bringToFront(w.id);
          const menuBtn = document.querySelector('[data-window="'+w.id+'"]');
          if(menuBtn) this.mm.syncButton(menuBtn, true);
        }
      }));
    }
    /* v4_4_5 change: Waking-context prompt auto-builds from Model Output + Context (live) */
    initWakingContextAutoBuild(){
      const modelOut = document.querySelector('#modelOutput, #model_output, textarea[name="modelOutput"]');
      const ctx      = document.querySelector('#wakingContextOutput, #waking_context_output, #wakingContext, textarea[name="wakingContext"]');
      const ctxPr    = document.querySelector('#wakingContextPrompt, #waking_context_prompt, textarea[name="wakingContextPrompt"]');
      if(!modelOut || !ctx || !ctxPr) return;
      const build = () => {
        const m = modelOut.value || modelOut.innerText || '';
        const c = ctx.value      || ctx.innerText      || '';
        ctxPr.value = m + (m && c ? "\n\n" : "") + c;
      };
      ['input','change','keyup'].forEach(ev => {
        modelOut.addEventListener(ev, build);
        ctx.addEventListener(ev, build);
      });
      build();
    }
  }

  /* v4_4_5 change: menu indicators on first load (after layout restore) */
  function syncMenuOnFirstLoad(menuManager){
    setTimeout(() => menuManager.syncAll(), 0);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const wm = new WindowManager();
    const mm = new MenuManager(wm);
    const sm = new SidebarManager();
    const pm = new PromptManager(wm, mm);

    /* v4_4_5 change: startup defaults — on first load, show all windows using v4_4_4 default geometry */
    try {
      const hasLayout = Object.keys(localStorage).some(k => /window(pos|size|vis)/i.test(k));
      if(!hasLayout){ wm.windows.forEach(w => wm.show(w.id)); }
    } catch(e){}

    syncMenuOnFirstLoad(mm);
  });
})();
</script>

</body>
</html>
